name: "E2E UI Test"

pr: none
trigger:
  tags:
    include:
      - "*"

pool:
  vmImage: "ubuntu-20.04"

resources:
  repositories:
    - repository: mobile-ui-tests
      type: github
      ref: feat/custom-working-directory
      name: OutSystems/mobile-ui-tests
      endpoint: OutSystems
    - repository: MobilePluginsODCPipeline
      type: github
      ref: feat/RMET-2294-uploadSaucelabs
      name: OutSystems/MobilePluginsODCPipeline
      endpoint: OutSystems

stages:
  - stage: Camera_E2E_Tests_Android
    variables:
      - group: "Camera Plugin Variables"
      - group: "Saucelabs User Variables"
    jobs:
      - job: checkout_repos
        steps:
          - checkout: self
          - checkout: mobile-ui-tests
          - checkout: MobilePluginsODCPipeline
          - template: build/ci/update-wrapper.yaml@MobilePluginsODCPipeline
            parameters:
              secretFileName: "eng-osrd-us-02-StampsInformation.json"
              PLUGIN_APP_KEY: "7acb2c1d-51bf-4ef4-8cb8-a05573501b6a"
              PLUGIN_UPDATE_URL: "https://github.com/OutSystems/cordova-plugin-camera#$(Build.SourceBranchName)"
              PLUGIN_UPDATE_VERSION: "$(Build.SourceBranchName)"
              workingDirectory: $(System.DefaultWorkingDirectory)/MobilePluginsODCPipeline
          - template: build/ci/refresh-sampleapp.yaml@MobilePluginsODCPipeline
            parameters:
              secretFileName: "eng-osrd-us-02-StampsInformation.json"
              SAMPLEAPP_APP_KEY: "3c0451ef-0d99-4e09-adb5-718e009deb9d"
              workingDirectory: $(System.DefaultWorkingDirectory)/MobilePluginsODCPipeline
          - script: |
              echo "##vso[task.setvariable variable=apkPath]$(cat /tmp/3c0451ef-0d99-4e09-adb5-718e009deb9d.apk-path)"
              echo "##vso[task.setvariable variable=ipaPath]$(cat /tmp/3c0451ef-0d99-4e09-adb5-718e009deb9d.ipa-path)"
            name: set_path_vars
            displayName: "Set package variables"
          - task: NodeTool@0
            displayName: 'Use Node 14.15.4'
            inputs:
              versionSpec: '14.15.4'
              checkLatest: true
          - task: npmAuthenticate@0
            displayName: 'npm Authenticate .npmrc'
            inputs:
              workingFile: '$(System.DefaultWorkingDirectory)/mobile-ui-tests/.npmrc'
          - task: CmdLine@2
            name: install_dep_cp
            displayName: 'Install dependencies using yarn'
            inputs:
              script: 'yarn'
              workingDirectory: $(System.DefaultWorkingDirectory)/mobile-ui-tests/
            continueOnError: true    
          - script: |
              npm run saucelabsUpload $(apkPath) -o /tmp/3c0451ef-0d99-4e09-adb5-718e009deb9d.android-slid
              npm run saucelabsUpload $(ipaPath) -o /tmp/3c0451ef-0d99-4e09-adb5-718e009deb9d.ios-slid
            workingDirectory: $(System.DefaultWorkingDirectory)/mobile-ui-tests
            name: upload_packages
            displayName: "Upload package to SauceLabs"
          - script: |
              echo "##vso[task.setvariable variable=androidSLID]$(cat /tmp/3c0451ef-0d99-4e09-adb5-718e009deb9d.android-slid)"
              echo "##vso[task.setvariable variable=iosSLID]$(cat /tmp/3c0451ef-0d99-4e09-adb5-718e009deb9d.ios-slid)"
            name: set_slid_vars
            displayName: "Set SauceLabs Storage IDs variables"
          - template: pipelines/templates/build-and-execute-tests-template.yml@mobile-ui-tests
            parameters:
              PACKAGE: $(ANDROID_PACKAGE_ID)
              MABS: 9
              DATACENTER: eu
              DEVICE: "samsung or google"
              DEVICE_PLATFORM: Android
              DEVICE_VERSION: 11
              PLATFORM_TYPE: Mobile
              PLUGIN: camera
              TAGS: "@p0"
              RETRY: 1
              TEST_TYPE: native
              THREADS: 3
              STORAGE_ID: $(ANDROID_SLID)
              WORKING_DIR: $(System.DefaultWorkingDirectory)/mobile-ui-tests
